<!DOCTYPE html>
<html>
<head>
	<title></title>
	<canvas id="ctx" width="500" height="500">
		It appears your browser doesn't support the canvas tag! Get chrome.
	</canvas>
	<script>
		Array.prototype.nullPush = function(item){
			var i = 0;
			var done = false;
			while(i < this.length && !done) {
				if(this[i] === null) {
					this[i] = item;
					return i;
				}
				i++;
			}
			i = this.length;
			this[i] = item;
			return i;
		}
	
		Array.prototype.nullForEach = function(func) {
			this.forEach(function(a, b, c) {
				if(a !== null){
					func(a, b, c);
				}
			});
		}
	
		var canvas = document.getElementById("ctx"),
			c = canvas.getContext("2d"),
			PI = Math.PI,
			TWO_PI = PI * 2,
			HALF_PI = PI/2,
			QUARTER_PI = PI/4,
			mouseX,
			mouseY,
			keyPressed = false,
			keysPressed = 0,
			keyIsPressed = false,
			width = canvas.width,
			height = canvas.height;
			LEFT = 37,
			UP = 38,
			RIGHT = 39,
			DOWN = 40,
			fps = 60; //Warning: affects simulation speed
		
		var keys = [];
		var colliders = [];
		var bullets = [];
		var enemies = [];
		var buttons = [];
		
		var emptyBulletIndeces = [];
		
		var timer = 1;
	</script>
	<script>
	
	
	
	function updateMouse(e) {
		var pos = getMousePos(canvas, e);
		mouseX = pos.x;
		mouseY = pos.y;
		}
	window.addEventListener('mousemove', updateMouse, false);

	function getMousePos(canvas, evt) {
		var rect = canvas.getBoundingClientRect();
		return {
		  x: evt.clientX - rect.left,
		  y: evt.clientY - rect.top
		};
	}
	
	
	
	window.addEventListener('click', onClick, false);
	
	function onClick() {
		console.log(bullets);
		buttons.forEach(function(button) {
			if(button.exists && button.checkMouseOver()) {
				button.onClick();
			}
		});
	}
	
	window.addEventListener('keyup',checkUp,false);
	function checkUp(e) {
		keys[e.keyCode] = false;
		keysPressed -= 1;
		if(keysPressed === 0) {
			keyIsPressed = false;
		} else {
			keyIsPressed = true;
		}
	}
	
	window.addEventListener('keydown',checkDown,false);
	function checkDown(e) {
		keys[e.keyCode] = true;
		keysPressed += 1;
	}
	
	var checkCollision = function(obj1, obj2) {
		realBound1 = obj1.boundingBox.getExactPos(obj1.position);
		realBound2 = obj2.boundingBox.getExactPos(obj2.position);
		if(realBound1.topLeft.x > realBound2.bottomRight.x) return false;
		if(realBound1.topLeft.y > realBound2.bottomRight.y) return false;
		if(realBound2.topLeft.x > realBound1.bottomRight.x) return false;
		if(realBound2.topLeft.y > realBound1.bottomRight.y) return false;

		return true;
	}
	
	var checkCollisions = function() {
		var anythingCollides = false;
		for (var i = 0; i < colliders.length; i++) {
			if(colliders[i]!== null) {
				for(var n = i + 1; n < colliders.length; n++) {
					if(colliders[n] !== null){							
						

						var collides = checkCollision(colliders[i], colliders[n]);
						if(collides) {
							var coli = colliders[i];
							var coln = colliders[n];
							colliders[i].onCollide(coln);
							colliders[n].onCollide(coli);
						}
					}
				}
			}
		}
	}
	
	</script>
	
	<script src="boundingBox.js"></script>
	<script src="vector.js"></script>
	<script src="ship.js"></script>
	<script src="bullet.js"></script>
	<script src="enemy1.js"></script>
	<script src="button.js"></script>
	<script>
		window.onload = function() {
			var btn = new Button(c, 150, 200, 200, 100,"Up/Down/Left/Right to move /n x to shoot /n Your health is displayed at the top left of the screen, if it reaches 0, you're dead /n Click on this rectangle to close it!", function () {
				this.exists = false;
			}, 10);
			
			setInterval(function() {
				keyPressed = false;
				c.fillStyle = "white";
				c.fillRect(0, 0, 500, 500);
				
				if(ship.isAlive){
					ship.doUserInput();
					ship.doBorders();
					ship.calculateAngularDrag();
					ship.applyDrag();
					ship.update();
					ship.display(c);
					ship.displayHealth(c);
				}
				checkCollisions();
				
				timer++;
				if(timer % (60 * 10) === 0){
					var r = Math.random() * 2;
					if(r <= 1) {
						if(r <= 0.5){
							new Enemy1(Math.random() * 400, 0);
						} else {
							new Enemy1(Math.random() * 400, 400);
						}
					} else {
						if(r <= 1.5) {
							new Enemy1(0, Math.random() * 400);
						} else {
							new Enemy1(400, Math.random() * 400);
						}
					}
				}
				
				bullets.nullForEach(function(bullet, i){
					bullet.update();
					bullet.draw(c);
				});
				
				enemies.nullForEach(function (enemy){
					enemy.pathFinding(ship);
					enemy.update();
					enemy.draw(c);
					
				});
				
				buttons.forEach(function(button) {
					if(button.exists) {
						button.draw(c);
					}
				});
				
				
			}, 1000/fps);
		};
	</script>
	<style>
	</style>
</head>
<body>
	
	
	
</body>
</html>